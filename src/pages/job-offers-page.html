<link rel="import" href="../../bower_components/polymer/polymer-element.html" />
<link rel="import" href="../../bower_components/marked-element/marked-element.html" />
<link rel="import" href="../../bower_components/plastic-image/plastic-image.html" />
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html" />
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html" />

<link rel="import" href="../mixins/utils-functions.html">
<link rel="import" href="../mixins/redux-mixin.html">
<link rel="import" href="../mixins/job-offers-hoc.html">
<link rel="import" href="../elements/shared-styles.html" />
<link rel="import" href="../elements/content-loader.html">
<link rel="import" href="../elements/text-truncate.html">

<dom-module id="job-offers-page">
  <template>
    <style
      is="custom-style"
      include="shared-styles flex flex-alignment"
    ></style>

    <style>
      :host {
        display: block;
      }

      .description-wrapper {
        background-color: var(--secondary-background-color);
        width: 100%;
      }

      .container {
        display: grid;
        grid-template-columns: 1fr;
        grid-gap: 24px;
        margin-bottom: 32px;
      }

      .job-offer-details {
        background: white;
        padding: 1em;
        box-shadow: 0px 0px 2px 1px rgba(0, 0, 0, 0.2);
        height: 260px;
        cursor: pointer;
        color: var(--primary-text-color);
        overflow: hidden;
      }

      .job-offer-details:hover {
        background: rgba(0, 0, 0, 0.2);
      }

      .job-offer-title {
        padding: 0 0 0.5em 0;
      }

      .job-offer-enterprise {
        display: flex;
        align-items: center;
      }

      .job-offer-link {
        align-self: flex-end;
        margin-top: auto;
      }

      @media (min-width: 640px) {
        .container {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (min-width: 1024px) {
        .container {
          grid-template-columns: repeat(3, 1fr);
        }
      }
    </style>

    <polymer-helmet
      title="{$ title $}"
      description="{$ heroSettings.jobOffers.metaDescription $}"
      active="[[active]]"
    ></polymer-helmet>

    <app-route
      route="[[route]]"
      pattern="/:jobOfferId"
      data="{{routeData}}"
    ></app-route>

    <hero-block
      background-image="{$ heroSettings.jobOffers.background.image $}"
      background-color="{$ heroSettings.jobOffers.background.color $}"
      font-color="{$ heroSettings.jobOffers.fontColor $}"
      active="[[active]]"
    >
      <div class="hero-title highlight-font">
        {$ heroSettings.jobOffers.title $}
      </div>
    </hero-block>

    <div class="description-wrapper">
      <div class="container" layout horizontal justified>
        <marked-element
          class="description"
          markdown="{$ heroSettings.jobOffers.metaDescription  $}"
        >
          <div slot="markdown-html"></div>
        </marked-element>
      </div>
    </div>
    <template is="dom-if" if="{{!contentLoaderVisibility}}">
        <paper-progress indeterminate></paper-progress>

        <content-loader
          class="container"
          card-padding="32px"
          card-height="260px"
          avatar-size="128px"
          avatar-circle="64px"
          horizontal-position="50%"
          box-shadow="var(--box-shadow)"
          items-count="{$ contentLoaders.jobOffers.itemsCount $}"
        ></content-loader>
    </template>

    <div class="container">
      <template is="dom-repeat" items="[[jobOffers]]" as="jobOffer">
        <a
        href$="/job-offers/[[jobOffer.id]]/"
        ga-on="click"
        ga-event-category="jobOffer"
        ga-event-action="open details"
        ga-event-label$="[[jobOffer.title]]"
        class="job-offer-details" layout vertical start-justified start>
          <h1 class="job-offer-title">{{ jobOffer.title }}</h1>
          <span class="job-offer-enterprise">
            <img src="{{ jobOffer.logo }}" height="42" class="job-offer-logo" />
            {{ jobOffer.enterprise }}
          </span>
          <text-truncate lines="5">
              <p class="job-offer-description">{{ jobOffer.description }}</p>
          </text-truncate>
        </a>
      </template>
    </div>

    <footer-block></footer-block>
  </template>

  <script>

    // eslint-disable-next-line no-undef
    class JobOffersPage extends UtilsFunctions(ReduxMixin(JobOffersHoC(Polymer.Element))) {
      static get is() {
        return 'job-offers-page';
      }

      static get properties() {
        return {
          route: Object,
          routeData: Object,
          active: Boolean,
          isDialogOpened: {
            type: Object,
            statePath: 'dialogs.jobOffer.isOpened',
            observer: '_dialogStatusChanged',
          },
          contentLoaderVisibility: {
            type: Boolean,
            value: false,
          },
        };
      }

      static get observers() {
        return [
          '_openJobOfferDetails(active, jobOffers, jobOffersMap, routeData.jobOfferId)',
          '_jobOffersChanged(jobOffers)',
        ];
      }

      _jobOffersChanged() {
        if (this.jobOffers && this.jobOffers.length) {
          this.contentLoaderVisibility = true;
        }
      }

      _dialogStatusChanged(nextState, prevState) {
        if (!nextState && prevState && this.active && this.routeData.jobOfferId) {
          history.back();
        }
      }

      _openJobOfferDetails(active, jobOffers, jobOffersMap, id) {
        if (jobOffers && jobOffers.length) {
          requestAnimationFrame(() => {
            if (active && id) {
              const jobOfferData = jobOffersMap[id];
              jobOfferData && dialogsActions.openDialog(DIALOGS.JOBOFFER, jobOfferData);
            } else if (this.isDialogOpened) {
              dialogsActions.closeDialog(DIALOGS.JOBOFFER);
            }
          });
        }
      }
    }

    window.customElements.define(JobOffersPage.is, JobOffersPage);
  </script>
</dom-module>
